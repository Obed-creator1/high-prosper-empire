{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}STOCK EMPIRE — LIVE COMMAND CENTER{% endblock %}

{% block extrahead %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Exo+2:wght@600;800&display=swap');
    body { background: linear-gradient(135deg, #0f0f23 0%, #1a1a3d 50%, #2d1b69 100%); color: white; }
    .glow { text-shadow: 0 0 20px #a855f7, 0 0 40px #a855f7; }
    .card-glow { box-shadow: 0 0 30px rgba(168, 85, 247, 0.5); }
    .pulse { animation: pulse 3s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 0.85; } 50% { opacity: 1; } }
    .filter-glow { box-shadow: 0 0 40px rgba(139, 92, 246, 0.6); }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen text-white p-6">
    <div class="max-w-7xl mx-auto">

        <!-- EMPIRE HEADER -->
        <div class="text-center mb-10">
            <h1 class="text-8xl font-black font-orbitron glow bg-gradient-to-r from-purple-400 via-pink-500 to-red-500 bg-clip-text text-transparent">
                STOCK EMPIRE
            </h1>
            <p class="text-3xl font-exo mt-4 opacity-90">REAL-TIME COMMAND CENTER</p>
            <div class="text-lg mt-3 opacity-70" id="clock"></div>
        </div>

        <!-- WAREHOUSE FILTER -->
        <div class="flex justify-center mb-12">
            <div class="bg-black/80 backdrop-blur-2xl rounded-3xl p-8 border-4 border-purple-600/80 filter-glow transform hover:scale-105 transition-all duration-300">
                <div class="flex items-center gap-8">
                    <i data-lucide="warehouse" class="w-14 h-14 text-purple-400"></i>
                    <div>
                        <label class="text-xl font-bold text-purple-300">SELECT DOMAIN</label>
                        <select id="warehouse-filter" class="mt-3 bg-gray-900/95 text-white text-2xl px-10 py-5 rounded-2xl border-4 border-purple-500/70 focus:outline-none focus:border-purple-300 transition-all cursor-pointer">
                            <option value="all">ALL WAREHOUSES — GLOBAL EMPIRE</option>
                            {% for w in warehouses %}
                            <option value="{{ w.id }}" {% if selected_warehouse == w.id|stringformat:"s" %}selected{% endif %}>
                            {{ w.name }} ({{ w.code }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="text-right">
                        <div class="text-sm opacity-70">Current View</div>
                        <div class="text-2xl font-bold" id="current-filter">ALL WAREHOUSES</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- LIVE STATS GRID -->
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-6 mb-12">
            <div class="bg-black/70 backdrop-blur-xl rounded-3xl p-8 card-glow border border-green-500/60 pulse">
                <i data-lucide="dollar-sign" class="w-14 h-14 text-green-400 mb-4"></i>
                <div class="text-5xl font-black" id="total-value">0 RWF</div>
                <div class="text-green-300 text-xl">Total Value</div>
            </div>
            <div class="bg-black/70 backdrop-blur-xl rounded-3xl p-8 card-glow border border-red-600/70">
                <i data-lucide="alert-circle" class="w-14 h-14 text-red-500 mb-4"></i>
                <div class="text-5xl font-black text-red-400" id="critical">0</div>
                <div class="text-red-300 text-xl">Critical</div>
            </div>
            <div class="bg-black/70 backdrop-blur-xl rounded-3xl p-8 card-glow border border-orange-500/60">
                <i data-lucide="trending-down" class="w-14 h-14 text-orange-400 mb-4"></i>
                <div class="text-5xl font-black text-orange-400" id="low-stock">0</div>
                <div class="text-orange-300 text-xl">Low Stock</div>
            </div>
            <div class="bg-black/70 backdrop-blur-xl rounded-3xl p-8 card-glow border border-cyan-500/60">
                <i data-lucide="truck" class="w-14 h-14 text-cyan-400 mb-4"></i>
                <div class="text-5xl font-black text-cyan-400" id="transfers">0</div>
                <div class="text-cyan-300 text-xl">Transfers</div>
            </div>
            <div class="bg-black/70 backdrop-blur-xl rounded-3xl p-8 card-glow border border-yellow-500/60">
                <i data-lucide="file-warning" class="w-14 h-14 text-yellow-400 mb-4"></i>
                <div class="text-5xl font-black text-yellow-400" id="pending">0</div>
                <div class="text-yellow-300 text-xl">Pending</div>
            </div>
            <div class="bg-black/70 backdrop-blur-xl rounded-3xl p-8 card-glow border border-emerald-500/60">
                <i data-lucide="arrow-up-right" class="w-14 h-14 text-emerald-400 mb-4"></i>
                <div class="text-5xl font-black text-emerald-400" id="in-today">0</div>
                <div class="text-emerald-300 text-xl">In Today</div>
            </div>
            <div class="bg-black/70 backdrop-blur-xl rounded-3xl p-8 card-glow border border-rose-500/60">
                <i data-lucide="arrow-down-right" class="w-14 h-14 text-rose-400 mb-4"></i>
                <div class="text-5xl font-black text-rose-400" id="out-today">0</div>
                <div class="text-rose-300 text-xl">Out Today</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
            <!-- LIVE STOCK VALUE CHART -->
            <div class="lg:col-span-2 bg-black/70 backdrop-blur-xl rounded-3xl p-10 card-glow border-4 border-purple-700/80">
                <h2 class="text-4xl font-black mb-8 flex items-center gap-5 text-cyan-300">
                    <i data-lucide="trending-up" class="w-12 h-12"></i>
                    Stock Value Trend (30 Days)
                </h2>
                <canvas id="valueTrendChart" height="420"></canvas>
            </div>

            <!-- CRITICAL ALERTS -->
            <div class="bg-black/70 backdrop-blur-xl rounded-3xl p-10 card-glow border-8 border-red-900/80">
                <h2 class="text-4xl font-black mb-8 flex items-center gap-5 text-red-500">
                    <i data-lucide="siren" class="w-12 h-12 animate-pulse"></i>
                    CRITICAL ALERTS
                </h2>
                <div id="alerts-container" class="space-y-5 max-h-96 overflow-y-auto pr-4">
                    <div class="text-center text-gray-400 py-16 text-2xl">Scanning empire...</div>
                </div>
            </div>
        </div>

        <!-- RECENT ACTIVITY -->
        <div class="mt-12 bg-black/70 backdrop-blur-xl rounded-3xl p-10 card-glow border-4 border-cyan-600/70">
            <h2 class="text-4xl font-black mb-8 flex items-center gap-5 text-yellow-400">
                <i data-lucide="zap" class="w-12 h-12"></i>
                Recent Activity Feed
            </h2>
            <div id="activity-feed" class="space-y-6 text-lg"></div>
        </div>
    </div>
</div>

<script>
    lucide.createIcons();

    let valueChart = null;

    // Initialize Chart
    function initChart(labels, data) {
        const ctx = document.getElementById('valueTrendChart').getContext('2d');

        if (valueChart) valueChart.destroy();

        valueChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Stock Value (RWF)',
                    data: data,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.2)',
                    borderWidth: 4,
                    pointBackgroundColor: '#10b981',
                    pointRadius: 6,
                    pointHoverRadius: 10,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.9)',
                        titleColor: '#10b981',
                        bodyColor: '#fff',
                        cornerRadius: 12,
                        displayColors: false,
                        callbacks: {
                            label: ctx => `RWF ${ctx.parsed.y.toLocaleString()}`
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { color: 'rgba(255,255,255,0.1)' },
                        ticks: { color: '#ccc' }
                    },
                    y: {
                        grid: { color: 'rgba(255,255,255,0.1)' },
                        ticks: {
                            color: '#ccc',
                            callback: value => 'RWF ' + value.toLocaleString()
                        }
                    }
                }
            }
        });
    }

    // Clock
    function updateClock() {
        const now = new Date();
        document.getElementById('clock').innerHTML = now.toLocaleDateString('en-GB', {
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
        }) + '<br>' + now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }
    setInterval(updateClock, 1000);
    updateClock();

    // Filter Logic
    const filterSelect = document.getElementById('warehouse-filter');
    const filterDisplay = document.getElementById('current-filter');

    filterSelect.addEventListener('change', function() {
        const selectedText = this.options[this.selectedIndex].text;
        filterDisplay.textContent = selectedText;
        const url = new URL(window.location);
        if (this.value === 'all') url.searchParams.delete('warehouse');
        else url.searchParams.set('warehouse', this.value);
        history.pushState({}, '', url);
        fetchLiveData();
    });

    // Main Data Fetcher
    function fetchLiveData() {
        let url = "{% url 'admin:dashboard-live' %}";
        const warehouseId = filterSelect.value;
        if (warehouseId && warehouseId !== 'all') {
            url += `?warehouse=${warehouseId}`;
        }

        fetch(url)
            .then(r => r.json())
            .then(data => {
                // Update Stats
                document.getElementById('total-value').textContent = Number(data.stats.total_value).toLocaleString() + ' RWF';
                document.getElementById('critical').textContent = data.stats.critical_items;
                document.getElementById('low-stock').textContent = data.stats.low_items;
                document.getElementById('transfers').textContent = data.stats.active_transfers;
                document.getElementById('pending').textContent = data.stats.pending_adjustments || 0;
                document.getElementById('in-today').textContent = data.stats.today_in.toLocaleString();
                document.getElementById('out-today').textContent = data.stats.today_out.toLocaleString();

                // Update Chart (if you add trend data in API later)
                // For now, placeholder smooth curve
                const labels = Array.from({length: 30}, (_, i) => {
                    const d = new Date();
                    d.setDate(d.getDate() - (29 - i));
                    return d.toLocaleDateString('en-GB', {day: 'numeric', month: 'short'});
                });
                const trendData = labels.map((_, i) => data.stats.total_value * (0.8 + Math.random() * 0.4));
                initChart(labels, trendData);

                // Alerts
                const alertsDiv = document.getElementById('alerts-container');
                alertsDiv.innerHTML = data.live_alerts.length ? data.live_alerts.map(a => `
                <div class="bg-gradient-to-r from-red-900/80 to-black/80 border-l-8 border-red-600 rounded-2xl p-6 animate-pulse hover:scale-105 transition-all">
                    <div class="flex justify-between">
                        <div>
                            <div class="text-2xl font-black">${a.stock__name}</div>
                            <div class="text-lg opacity-80">${a.stock__item_code} • ${a.warehouse__name}</div>
                            <div class="text-4xl font-black mt-3 text-red-400">${a.current_quantity} / ${a.threshold_value}</div>
                        </div>
                        <span class="px-6 py-3 bg-red-800 rounded-full text-xl font-bold">${a.severity.toUpperCase()}</span>
                    </div>
                </div>
            `).join('') : '<div class="text-center text-green-400 py-20 text-3xl font-bold">ALL CLEAR — EMPIRE SECURE</div>';

                // Activity Feed
                document.getElementById('activity-feed').innerHTML = data.recent_activity.map(t => `
                <div class="flex justify-between items-center py-6 border-b border-purple-500/30 hover:bg-white/5 rounded-xl px-4 transition-all">
                    <div>
                        <div class="text-2xl font-bold">${t.stock__name} <span class="text-sm opacity-60">(${t.stock__item_code})</span></div>
                        <div class="text-lg opacity-70">${t.from_warehouse__name || ''} → ${t.to_warehouse__name || ''} • ${t.user__username || 'System'}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-5xl font-black ${t.transaction_type === 'in' ? 'text-green-400' : 'text-red-400'}">
                            ${t.transaction_type === 'in' ? '+' : '-'}${t.quantity}
                        </div>
                        <div class="text-sm opacity-60">${new Date(t.created_at).toLocaleTimeString()}</div>
                    </div>
                </div>
            `).join('');
            })
            .catch(err => console.error('Empire comms lost:', err));
    }

    // Start the Empire
    fetchLiveData();
    setInterval(fetchLiveData, 6000);
</script>
{% endblock %}